<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Fiscaliza√ß√£o - Ocorr√™ncias</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Registro de Ocorr√™ncias - Fiscaliza√ß√£o" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0d47a1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: linear-gradient(90deg, #0d47a1, #1976d2);
      color: #fff;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    header .version {
      margin-left: auto;
      font-size: 11px;
      opacity: 0.8;
    }
    main {
      max-width: 960px;
      margin: 8px auto 24px;
      padding: 0 12px;
    }
    section.card {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
    }
    section.card h2 {
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    section.card h2 span.badge {
      background: #eff6ff;
      color: #1d4ed8;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 500;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-bottom: 8px;
      flex: 1 1 120px;
      min-width: 0;
    }
    .field label {
      font-size: 12px;
      font-weight: 500;
      color: #374151;
    }
    .field input,
    .field select,
    .field textarea {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 6px 8px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }
    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
      background: #ffffff;
    }
    .field textarea {
      min-height: 80px;
      resize: vertical;
    }
    .field small {
      font-size: 11px;
      color: #6b7280;
    }
    .field-inline {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .field-inline label {
      font-weight: 500;
      color: #374151;
    }
    .field-inline input[type="checkbox"] {
      width: 14px;
      height: 14px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
      transition: background 0.15s, transform 0.1s, box-shadow 0.1s;
    }
    button.secondary {
      background: #f3f4f6;
      color: #111827;
      box-shadow: none;
      border-radius: 999px;
      border: 1px solid #d1d5db;
    }
    button.danger {
      background: #b91c1c;
      box-shadow: 0 2px 6px rgba(185, 28, 28, 0.35);
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.15);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }
    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      border: 1px solid #d1d5db;
      cursor: pointer;
      background: #f9fafb;
      color: #374151;
    }
    .chip.active {
      background: #eff6ff;
      border-color: #2563eb;
      color: #1d4ed8;
      font-weight: 500;
    }
    .footer-hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    .hidden {
      display: none !important;
    }
    .pill-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ecfdf5;
      color: #166534;
      border: 1px solid #bbf7d0;
      margin-left: 4px;
    }
    .pill-tag span {
      font-weight: 600;
    }
    .toggle-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .toggle-row label {
      font-weight: 500;
    }
    .small-note {
      font-size: 11px;
      color: #6b7280;
    }
    .photos-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .photos-row input[type="file"] {
      font-size: 12px;
    }
    .photo-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .photo-preview img {
      width: 72px;
      height: 72px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .photo-card {
      position: relative;
    }
    .photo-card button.remove-photo {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: none;
      background: rgba(239, 68, 68, 0.9);
      color: #fff;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.25);
    }
    .alert {
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .alert.info {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }
    .alert.warning {
      background: #fffbeb;
      color: #92400e;
      border: 1px solid #fed7aa;
    }
    .alert.success {
      background: #ecfdf5;
      color: #15803d;
      border: 1px solid #bbf7d0;
    }
    .inline-code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #f3f4f6;
      padding: 2px 5px;
      border-radius: 4px;
      font-size: 11px;
    }
    @media (max-width: 640px) {
      header h1 {
        font-size: 16px;
      }
      section.card {
        padding: 10px;
      }
      .btn-row {
        flex-direction: column;
        align-items: stretch;
      }
      button {
        justify-content: center;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div style="font-size:11px; opacity:0.9;">APP Fiscaliza√ß√£o</div>
      <h1>Registro de Ocorr√™ncias</h1>
    </div>
    <span class="version">v1.0.0</span>
  </header>
  <main>
    <!-- Dados do Fiscal -->
    <section class="card">
      <h2>Dados do Fiscal <span class="badge">Identifica√ß√£o</span></h2>
      <div class="row">
        <div class="field">
          <label for="fiscal_nome">Nome do Fiscal</label>
          <input type="text" id="fiscal_nome" placeholder="Ex: Jo√£o Silva" />
        </div>
        <div class="field">
          <label for="fiscal_matricula">Matr√≠cula</label>
          <input type="text" id="fiscal_matricula" placeholder="Ex: 12345" />
        </div>
        <div class="field">
          <label for="fiscal_base">Base / Local</label>
          <input type="text" id="fiscal_base" placeholder="Ex: Terminal Piraj√°" />
        </div>
      </div>
    </section>

    <!-- Dados B√°sicos da Ocorr√™ncia -->
    <section class="card">
      <h2>Dados B√°sicos <span class="badge">Ocorr√™ncia</span></h2>
      <div class="row">
        <div class="field">
          <label for="oc_data">Data</label>
          <input type="date" id="oc_data" />
        </div>
        <div class="field">
          <label for="oc_hora">Hora</label>
          <input type="time" id="oc_hora" />
        </div>
        <div class="field">
          <label for="oc_cidade">Cidade / Local</label>
          <input type="text" id="oc_cidade" placeholder="Ex: Salvador - BA" />
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label for="oc_linha">Linha</label>
          <input type="text" id="oc_linha" placeholder="Ex: Salvador x Alagoinhas" />
        </div>
        <div class="field">
          <label for="oc_prefixo">Prefixo do Ve√≠culo</label>
          <input type="text" id="oc_prefixo" placeholder="Ex: 9380" />
        </div>
        <div class="field">
          <label for="oc_placa">Placa</label>
          <input type="text" id="oc_placa" placeholder="Ex: ABC-1234" />
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label for="oc_tipo">Tipo de Ocorr√™ncia</label>
          <select id="oc_tipo">
            <option value="">Selecione...</option>
            <option value="Passageiro sem bilhete">Passageiro sem bilhete</option>
            <option value="Falta de presta√ß√£o de contas">Falta de presta√ß√£o de contas</option>
            <option value="Venda incorreta">Venda incorreta</option>
            <option value="Descida irregular">Descida irregular</option>
            <option value="Outros">Outros</option>
          </select>
        </div>
        <div class="field">
          <label for="oc_gravidade">Gravidade</label>
          <select id="oc_gravidade">
            <option value="">Selecione...</option>
            <option value="Baixa">Baixa</option>
            <option value="M√©dia">M√©dia</option>
            <option value="Alta">Alta</option>
          </select>
        </div>
        <div class="field">
          <label for="oc_envolvidos">Envolvidos (motorista, cobrador, etc.)</label>
          <input type="text" id="oc_envolvidos" placeholder="Ex: Motorista - Jo√£o; Cobrador - Carlos" />
        </div>
      </div>
    </section>

    <!-- Descri√ß√£o da Ocorr√™ncia -->
    <section class="card">
      <h2>Descri√ß√£o da Ocorr√™ncia</h2>
      <div class="field">
        <label for="oc_resumo">Resumo da Ocorr√™ncia</label>
        <textarea id="oc_resumo" placeholder="Descreva resumidamente o que foi identificado..."></textarea>
        <small>Ex.: Passageiro foi identificado sem bilhete embarcado no trecho Salvador x Sim√µes Filho.</small>
      </div>
      <div class="field">
        <label for="oc_detalhes">Detalhamento (o qu√™, quando, onde, quem, como)</label>
        <textarea id="oc_detalhes" placeholder="Inclua o m√°ximo de informa√ß√µes √∫teis para an√°lise posterior..."></textarea>
      </div>
      <div class="field">
        <label for="oc_acoes">A√ß√µes adotadas pelo fiscal</label>
        <textarea id="oc_acoes" placeholder="Ex.: Passageiro orientado a regularizar bilhete; tripula√ß√£o orientada; registro no sistema..."></textarea>
      </div>
    </section>

    <!-- Evid√™ncias e Fotos -->
    <section class="card">
      <h2>Evid√™ncias <span class="badge">Fotos / Documentos</span></h2>
      <div class="photos-row">
        <div class="field">
          <label for="oc_fotos">Fotos da Ocorr√™ncia</label>
          <input type="file" id="oc_fotos" accept="image/*" multiple />
          <small>Opcional. As fotos n√£o ser√£o enviadas para servidor, apenas utilizadas para gerar o PDF localmente.</small>
        </div>
        <div id="photo_preview" class="photo-preview"></div>
      </div>
      <div class="alert info">
        As evid√™ncias s√£o importantes para embasar poss√≠veis medidas internas (orienta√ß√£o, advert√™ncia, suspens√£o, etc.).
      </div>
    </section>

    <!-- Classifica√ß√£o / Encaminhamento -->
    <section class="card">
      <h2>Classifica√ß√£o e Encaminhamento</h2>
      <div class="row">
        <div class="field">
          <label for="oc_classificacao">Classifica√ß√£o</label>
          <select id="oc_classificacao">
            <option value="">Selecione...</option>
            <option value="Orienta√ß√£o">Orienta√ß√£o</option>
            <option value="Advert√™ncia">Advert√™ncia</option>
            <option value="Suspens√£o">Suspens√£o</option>
            <option value="Outros encaminhamentos">Outros encaminhamentos</option>
          </select>
        </div>
        <div class="field">
          <label for="oc_setor">Setor Respons√°vel</label>
          <select id="oc_setor">
            <option value="">Selecione...</option>
            <option value="Opera√ß√£o">Opera√ß√£o</option>
            <option value="Comercial">Comercial</option>
            <option value="RH">RH</option>
            <option value="Financeiro">Financeiro</option>
            <option value="Outros">Outros</option>
          </select>
        </div>
        <div class="field">
          <label for="oc_prazo">Prazo para retorno / provid√™ncias</label>
          <input type="date" id="oc_prazo" />
        </div>
      </div>
      <div class="field">
        <label for="oc_observacoes">Observa√ß√µes ao setor respons√°vel</label>
        <textarea id="oc_observacoes" placeholder="Ex.: Solicitar an√°lise de imagens, confer√™ncia de presta√ß√£o de contas, etc."></textarea>
      </div>
    </section>

    <!-- Gera√ß√£o e Compartilhamento -->
    <section class="card">
      <h2>Gera√ß√£o e Compartilhamento</h2>
      <div class="toggle-row">
        <label>Formato de registro:</label>
        <div class="chip-group">
          <button type="button" class="chip active" data-format="pdf">PDF</button>
          <button type="button" class="chip" data-format="link">Link (texto compartilh√°vel)</button>
        </div>
      </div>
      <div class="field-inline">
        <label for="oc_anonimo">Ocorr√™ncia an√¥nima:</label>
        <input type="checkbox" id="oc_anonimo" />
        <span class="small-note">(oculta o nome do fiscal no texto enviado)</span>
      </div>
      <div class="btn-row">
        <button id="btn_gerar_pdf_ocorrencia" type="button">
          üìÑ Gerar PDF da Ocorr√™ncia
        </button>
        <button id="btn_gerar_link_ocorrencia" type="button" class="secondary">
          üîó Gerar Link / Texto
        </button>
        <button id="btn_limpar" type="button" class="secondary">
          üßπ Limpar Tudo
        </button>
      </div>
      <div class="footer-hint">
        O PDF √© gerado localmente no seu dispositivo. Nenhuma informa√ß√£o √© enviada para servidor.
      </div>
      <div class="alert warning hidden" id="offline_alert">
        Voc√™ est√° offline. O PDF continuar√° sendo gerado localmente, mas funcionalidades que dependem de internet podem n√£o funcionar.
      </div>
      <div class="alert success hidden" id="copy_success">
        Texto da ocorr√™ncia copiado com sucesso para a √°rea de transfer√™ncia!
      </div>
    </section>
  </main>

  <script>
    // Refer√™ncias aos elementos
    const fiscal = document.getElementById("fiscal_nome");
    const fiscalMatricula = document.getElementById("fiscal_matricula");
    const fiscalBase = document.getElementById("fiscal_base");
    const dataInput = document.getElementById("oc_data");
    const horaInput = document.getElementById("oc_hora");
    const cidadeInput = document.getElementById("oc_cidade");
    const linhaInput = document.getElementById("oc_linha");
    const prefixoInput = document.getElementById("oc_prefixo");
    const placaInput = document.getElementById("oc_placa");
    const tipoInput = document.getElementById("oc_tipo");
    const gravidadeInput = document.getElementById("oc_gravidade");
    const envolvidosInput = document.getElementById("oc_envolvidos");
    const resumoInput = document.getElementById("oc_resumo");
    const detalhesInput = document.getElementById("oc_detalhes");
    const acoesInput = document.getElementById("oc_acoes");
    const classificacaoInput = document.getElementById("oc_classificacao");
    const setorInput = document.getElementById("oc_setor");
    const prazoInput = document.getElementById("oc_prazo");
    const obsInput = document.getElementById("oc_observacoes");
    const anonimoCheckbox = document.getElementById("oc_anonimo");

    const oc_fotos = document.getElementById("oc_fotos");
    const photoPreview = document.getElementById("photo_preview");

    const oc_pdf_btn = document.getElementById("btn_gerar_pdf_ocorrencia");
    const oc_link_btn = document.getElementById("btn_gerar_link_ocorrencia");
    const limpar_btn = document.getElementById("btn_limpar");

    const offline_alert = document.getElementById("offline_alert");
    const copy_success = document.getElementById("copy_success");

    const formatChips = document.querySelectorAll(".chip-group .chip");

    let fotosSelecionadas = [];

    // Controle de formato
    let formatoSelecionado = "pdf";
    formatChips.forEach((chip) => {
      chip.addEventListener("click", () => {
        formatChips.forEach((c) => c.classList.remove("active"));
        chip.classList.add("active");
        formatoSelecionado = chip.dataset.format || "pdf";
      });
    });

    // Offline/online
    function updateOnlineStatus() {
      if (!navigator.onLine) {
        offline_alert.classList.remove("hidden");
      } else {
        offline_alert.classList.add("hidden");
      }
    }
    window.addEventListener("online", updateOnlineStatus);
    window.addEventListener("offline", updateOnlineStatus);
    updateOnlineStatus();

    // Fotos
    oc_fotos.addEventListener("change", (event) => {
      const files = Array.from(event.target.files || []);
      fotosSelecionadas = files;
      renderPhotoPreview();
    });

    function renderPhotoPreview() {
      photoPreview.innerHTML = "";
      if (!fotosSelecionadas.length) return;

      fotosSelecionadas.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const card = document.createElement("div");
          card.className = "photo-card";
          const img = document.createElement("img");
          img.src = e.target.result;
          img.alt = `Foto ${index + 1}`;
          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-photo";
          removeBtn.textContent = "√ó";
          removeBtn.onclick = () => {
            fotosSelecionadas.splice(index, 1);
            renderPhotoPreview();
          };
          card.appendChild(img);
          card.appendChild(removeBtn);
          photoPreview.appendChild(card);
        };
        reader.readAsDataURL(file);
      });
    }

    // Texto da ocorr√™ncia
    function montarTextoOcorrencia() {
      const fiscalNome = fiscal.value || "";
      const fiscalMat = fiscalMatricula.value || "";
      const base = fiscalBase.value || "";
      const dataOcc = dataInput.value || "";
      const horaOcc = horaInput.value || "";
      const cidade = cidadeInput.value || "";
      const linha = linhaInput.value || "";
      const prefixo = prefixoInput.value || "";
      const placa = placaInput.value || "";
      const tipo = tipoInput.value || "";
      const gravidade = gravidadeInput.value || "";
      const envolvidos = envolvidosInput.value || "";
      const resumo = resumoInput.value || "";
      const detalhes = detalhesInput.value || "";
      const acoes = acoesInput.value || "";
      const classificacao = classificacaoInput.value || "";
      const setor = setorInput.value || "";
      const prazo = prazoInput.value || "";
      const obs = obsInput.value || "";
      const anonimo = anonimoCheckbox.checked;

      let texto = "";
      texto += "REGISTRO DE OCORR√äNCIA - FISCALIZA√á√ÉO\n";
      texto += "-------------------------------------\n\n";

      if (!anonimo) {
        texto += `Fiscal: ${fiscalNome || "N√£o informado"}\n`;
        if (fiscalMat) texto += `Matr√≠cula: ${fiscalMat}\n`;
        if (base) texto += `Base/Local: ${base}\n`;
        texto += "\n";
      } else {
        texto += "Fiscal: [Ocorr√™ncia registrada como AN√îNIMA]\n\n";
      }

      texto += "DADOS B√ÅSICOS DA OCORR√äNCIA\n";
      texto += `Data: ${dataOcc || "-"}\n`;
      texto += `Hora: ${horaOcc || "-"}\n`;
      texto += `Cidade/Local: ${cidade || "-"}\n`;
      texto += `Linha: ${linha || "-"}\n`;
      texto += `Prefixo do Ve√≠culo: ${prefixo || "-"}\n`;
      texto += `Placa: ${placa || "-"}\n`;
      texto += `Tipo de Ocorr√™ncia: ${tipo || "-"}\n`;
      texto += `Gravidade: ${gravidade || "-"}\n`;
      texto += `Envolvidos: ${envolvidos || "-"}\n`;
      texto += "\n";

      texto += "DESCRI√á√ÉO DA OCORR√äNCIA\n";
      texto += `Resumo: ${resumo || "-"}\n\n`;
      texto += `Detalhamento: ${detalhes || "-"}\n\n`;
      texto += `A√ß√µes adotadas pelo fiscal: ${acoes || "-"}\n\n`;

      texto += "CLASSIFICA√á√ÉO / ENCAMINHAMENTO\n";
      texto += `Classifica√ß√£o: ${classificacao || "-"}\n`;
      texto += `Setor respons√°vel: ${setor || "-"}\n`;
      texto += `Prazo para retorno/provid√™ncias: ${prazo || "-"}\n`;
      texto += `Observa√ß√µes ao setor respons√°vel: ${obs || "-"}\n`;

      if (fotosSelecionadas.length) {
        texto += "\nEVID√äNCIAS\n";
        texto += `Quantidade de fotos anexadas: ${fotosSelecionadas.length}\n`;
        texto += "As imagens est√£o anexas ao PDF gerado.\n";
      }

      texto += "\n-------------------------------------\n";
      texto += "Registro gerado via APP de Fiscaliza√ß√£o.\n";

      return texto;
    }

    // Gera√ß√£o de PDF da Ocorr√™ncia (AJUSTADO)
    async function gerarPDFOcorrencia() {
      console.log('Clique no bot√£o Gerar PDF da Ocorr√™ncia recebido.');

      const jsPDFLib =
        (window.jspdf && window.jspdf.jsPDF) ||
        window.jsPDF ||
        null;

      if (!jsPDFLib) {
        console.error('jsPDF n√£o encontrado. window.jspdf =', window.jspdf, 'window.jsPDF =', window.jsPDF);
        alert("N√£o foi poss√≠vel carregar o gerador de PDF (jsPDF). Verifique se o arquivo foi aberto com internet ou se a biblioteca foi carregada corretamente.");
        return;
      }

      const doc = new jsPDFLib();

      const fiscalNome = fiscal.value || "";
      const dataOcc = dataInput.value || "";

      let y = 15;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("REGISTRO DE OCORR√äNCIA - FISCALIZA√á√ÉO", 10, y);
      y += 8;

      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");

      const anonimo = anonimoCheckbox.checked;
      if (!anonimo) {
        const linhaFiscal = `Fiscal: ${fiscalNome || "N√£o informado"}`;
        doc.text(linhaFiscal, 10, y);
        y += 6;
        const mat = fiscalMatricula.value || "";
        const base = fiscalBase.value || "";
        if (mat) {
          doc.text(`Matr√≠cula: ${mat}`, 10, y);
          y += 6;
        }
        if (base) {
          doc.text(`Base/Local: ${base}`, 10, y);
          y += 6;
        }
      } else {
        doc.text("Fiscal: [Ocorr√™ncia registrada como AN√îNIMA]", 10, y);
        y += 6;
      }

      y += 2;
      doc.setFont("helvetica", "bold");
      doc.text("DADOS B√ÅSICOS DA OCORR√äNCIA", 10, y);
      y += 6;
      doc.setFont("helvetica", "normal");

      const horaOcc = horaInput.value || "";
      const cidade = cidadeInput.value || "";
      const linha = linhaInput.value || "";
      const prefixo = prefixoInput.value || "";
      const placa = placaInput.value || "";
      const tipo = tipoInput.value || "";
      const gravidade = gravidadeInput.value || "";
      const envolvidos = envolvidosInput.value || "";

      const dadosBasicos = [
        `Data: ${dataOcc || "-"}`,
        `Hora: ${horaOcc || "-"}`,
        `Cidade/Local: ${cidade || "-"}`,
        `Linha: ${linha || "-"}`,
        `Prefixo do Ve√≠culo: ${prefixo || "-"}`,
        `Placa: ${placa || "-"}`,
        `Tipo de Ocorr√™ncia: ${tipo || "-"}`,
        `Gravidade: ${gravidade || "-"}`,
        `Envolvidos: ${envolvidos || "-"}`
      ];

      dadosBasicos.forEach((linhaText) => {
        const textoQuebrado = doc.splitTextToSize(linhaText, 190);
        doc.text(textoQuebrado, 10, y);
        y += textoQuebrado.length * 5;
      });

      y += 2;
      doc.setFont("helvetica", "bold");
      doc.text("DESCRI√á√ÉO DA OCORR√äNCIA", 10, y);
      y += 6;
      doc.setFont("helvetica", "normal");

      const resumo = resumoInput.value || "";
      const detalhes = detalhesInput.value || "";
      const acoes = acoesInput.value || "";

      const descricaoBlocos = [
        { titulo: "Resumo", texto: resumo || "-" },
        { titulo: "Detalhamento", texto: detalhes || "-" },
        { titulo: "A√ß√µes adotadas pelo fiscal", texto: acoes || "-" },
      ];

      descricaoBlocos.forEach((bloco) => {
        const titulo = bloco.titulo + ":";
        doc.setFont("helvetica", "bold");
        doc.text(titulo, 10, y);
        y += 5;
        doc.setFont("helvetica", "normal");
        const textoQuebrado = doc.splitTextToSize(bloco.texto, 190);
        doc.text(textoQuebrado, 10, y);
        y += textoQuebrado.length * 5 + 2;
      });

      y += 2;
      doc.setFont("helvetica", "bold");
      doc.text("CLASSIFICA√á√ÉO / ENCAMINHAMENTO", 10, y);
      y += 6;
      doc.setFont("helvetica", "normal");

      const classificacao = classificacaoInput.value || "";
      const setor = setorInput.value || "";
      const prazo = prazoInput.value || "";
      const obs = obsInput.value || "";

      const linhaText = [
        "Classifica√ß√£o: " + (classificacao || "-"),
        "Setor respons√°vel: " + (setor || "-"),
        "Prazo para retorno/provid√™ncias: " + (prazo || "-"),
        "Observa√ß√µes ao setor respons√°vel: " + (obs || "-")
      ];

      linhaText.forEach((txt) => {
        const textoQuebrado = doc.splitTextToSize(txt, 190);
        doc.text(textoQuebrado, 10, y);
        y += textoQuebrado.length * 5;
      });

      if (fotosSelecionadas.length > 0) {
        y += 4;
        doc.setFont("helvetica", "bold");
        doc.text("EVID√äNCIAS (FOTOS)", 10, y);
        y += 6;
        doc.setFont("helvetica", "normal");
        doc.text(
          `Quantidade de fotos anexadas: ${fotosSelecionadas.length}. As imagens ser√£o inseridas a seguir, conforme espa√ßo dispon√≠vel.`,
          10,
          y
        );
        y += 8;

        for (let i = 0; i < fotosSelecionadas.length; i++) {
          const file = fotosSelecionadas[i];
          await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const imgData = e.target.result;
              try {
                doc.addImage(imgData, "JPEG", 10, y, 60, 45);
                y += 50;
                if (y > 260 && i < fotosSelecionadas.length - 1) {
                  doc.addPage();
                  y = 15;
                }
              } catch (error) {
                console.error("Erro ao adicionar imagem ao PDF:", error);
              }
              resolve();
            };
            reader.readAsDataURL(file);
          });
        }
      }

      doc.setFontSize(9);
      doc.setFont("helvetica", "italic");
      if (y > 270) {
        doc.addPage();
        y = 15;
      }
      y += 4;
      doc.text("Registro gerado via APP de Fiscaliza√ß√£o.", 10, y);

      let nomeArquivo = "ocorrencia_fiscalizacao";
      if (dataOcc) {
        nomeArquivo += "_" + dataOcc.replace(/-/g, "");
      }
      if (fiscalNome) {
        nomeArquivo += "_" + fiscalNome.split(" ")[0].toLowerCase();
      }
      nomeArquivo += ".pdf";

      doc.save(nomeArquivo);
    }

    // Gerar texto / link
    async function gerarTextoOcorrencia() {
      const texto = montarTextoOcorrencia();
      try {
        await navigator.clipboard.writeText(texto);
        copy_success.classList.remove("hidden");
        setTimeout(() => {
          copy_success.classList.add("hidden");
        }, 2500);
        alert("Texto da ocorr√™ncia copiado para a √°rea de transfer√™ncia. Cole no WhatsApp, e-mail ou onde preferir.");
      } catch (err) {
        console.error("Erro ao copiar para √°rea de transfer√™ncia:", err);
        alert("N√£o foi poss√≠vel copiar automaticamente. Irei exibir o texto para que voc√™ copie manualmente.");
        const blob = new Blob([texto], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
      }
    }

    // Limpar tudo
    function limparCamposOcorrencia() {
      const inputs = [
        fiscal, fiscalMatricula, fiscalBase, dataInput, horaInput, cidadeInput, linhaInput,
        prefixoInput, placaInput, tipoInput, gravidadeInput, envolvidosInput, resumoInput,
        detalhesInput, acoesInput, classificacaoInput, setorInput, prazoInput, obsInput
      ];
      inputs.forEach((el) => {
        if (!el) return;
        if (el.tagName === "SELECT") {
          el.selectedIndex = 0;
        } else {
          el.value = "";
        }
      });
      anonimoCheckbox.checked = false;
      fotosSelecionadas = [];
      renderPhotoPreview();
    }

    // Eventos
    if (oc_pdf_btn) oc_pdf_btn.onclick = gerarPDFOcorrencia;
    if (oc_link_btn) oc_link_btn.onclick = gerarTextoOcorrencia;
    if (limpar_btn) limpar_btn.onclick = limparCamposOcorrencia;

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("sw.js")
          .then((reg) => console.log("Service Worker registrado:", reg.scope))
          .catch((err) => console.error("Falha ao registrar Service Worker:", err));
      });
    }
  </script>

  <!-- jsPDF UMD (mantido) -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    integrity="sha512-XcRPwN1x7k3prVqUNShUMpOWcZH/5LiCFYI8a9kaI0s5momkGLumZ5qX6Ch12HaxJXhMHDL/95B2S/bjXrd6WQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer">
  </script>
</body>
</html>
